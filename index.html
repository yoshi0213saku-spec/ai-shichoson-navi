<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI市町村ナビ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap');
    body { font-family: 'Sawarabi Mincho', serif; background-color: #f5f5f0; color: #1a1a1a; }
    .leaflet-container { width: 100%; height: 300px; border-radius: 12px; }
    .brand-color { color: #001f3f; }
    .bg-brand { background-color: #001f3f; }
  </style>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom": "https://esm.sh/react-dom@18.2.0/client",
      "@google/genai": "https://esm.sh/@google/genai@0.2.1"
    }
  }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect } from 'react';
    import { createRoot } from 'react-dom';
    import { GoogleGenAI } from "@google/genai";

    function App() {
      const [apiKey, setApiKey] = useState('');
      const [query, setQuery] = useState('');
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      useEffect(() => {
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) setApiKey(savedKey);
      }, []);

      const saveKey = () => {
        const trimmedKey = apiKey.trim();
        localStorage.setItem('gemini_api_key', trimmedKey);
        setApiKey(trimmedKey);
        alert('APIキーを保存しました');
      };

      const handleSearch = async () => {
        if (!query || !apiKey) return;
        setLoading(true);
        setError(null);
        try {
          const genAI = new GoogleGenAI(apiKey);
          const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
          const prompt = `日本の「${query}」について、以下の項目をJSON形式で教えてください：name(市町村名), prefecture(都道府県), description(概要), tourism(観光特徴), people(ゆかりの人物リスト: name, bioを含む), population(総人口, 高齢化率), lat(緯度), lng(経度)`;
          
          const result = await model.generateContent(prompt);
          const response = await result.response;
          const text = response.text().replace(/```json|```/g, '');
          setData(JSON.parse(text));
        } catch (err) {
          setError("エラーが発生しました。APIキーまたは制限を確認してください。");
        } finally {
          setLoading(false);
        }
      };

      return React.createElement('div', { className: 'max-w-4xl mx-auto p-4' },
        React.createElement('h1', { className: 'text-3xl font-bold mb-6 brand-color text-center border-b-2 border-stone-300 pb-2' }, 'AI市町村ナビ'),
        
        // 設定エリア
        React.createElement('div', { className: 'bg-white p-4 rounded-xl shadow-sm mb-6' },
          React.createElement('label', { className: 'block text-sm mb-1' }, 'Gemini API Key:'),
          React.createElement('div', { className: 'flex gap-2' },
            React.createElement('input', {
              type: 'password', value: apiKey, onChange: e => setApiKey(e.target.value),
              className: 'flex-1 border p-2 rounded', placeholder: 'AIza...'
            }),
            React.createElement('button', { onClick: saveKey, className: 'bg-stone-700 text-white px-4 py-2 rounded' }, '保存')
          )
        ),

        // 検索エリア
        React.createElement('div', { className: 'flex gap-2 mb-8' },
          React.createElement('input', {
            type: 'text', value: query, onChange: e => setQuery(e.target.value),
            className: 'flex-1 border p-3 rounded-full shadow-inner', placeholder: '例：南相木村'
          }),
          React.createElement('button', { onClick: handleSearch, className: 'bg-brand text-white px-6 py-3 rounded-full font-bold' }, loading ? '照合中...' : '検索')
        ),

        error && React.createElement('p', { className: 'text-red-500 mb-4' }, error),

        data && React.createElement('div', { className: 'grid md:grid-cols-2 gap-6' },
          React.createElement('div', { className: 'bg-white p-6 rounded-2xl shadow' },
            React.createElement('h2', { className: 'text-2xl font-bold brand-color' }, data.name),
            React.createElement('p', { className: 'text-sm text-stone-500 mb-4' }, data.prefecture),
            React.createElement('p', { className: 'leading-relaxed' }, data.description),
            React.createElement('div', { className: 'mt-4 pt-4 border-t' },
              React.createElement('p', {}, `人口：${data.population.total}`),
              React.createElement('p', {}, `高齢化率：${data.population.agingRate}`)
            )
          ),
          React.createElement('div', { className: 'bg-white p-6 rounded-2xl shadow' },
            React.createElement('h3', { className: 'font-bold mb-2' }, 'ゆかりの人物'),
            data.people.map((p, i) => React.createElement('div', { key: i, className: 'mb-3 text-sm' },
              React.createElement('strong', { className: 'brand-color' }, p.name),
              React.createElement('p', {}, p.bio)
            ))
          )
        )
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>