<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI市町村ナビ</title>
  
  <!-- CSS Libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- JS Libraries (UMD/Global) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
      margin: 0;
    }

    #map {
      width: 100%;
      height: 320px;
      background: #f1f5f9;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      z-index: 1;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #e2e8f0;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #cbd5e1;
    }

    .brand-gradient {
      background: #10b981;
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#10b981',
          }
        }
      }
    }
  </script>
</head>
<body>
  <div id="root">
    <div class="min-h-screen flex items-center justify-center bg-slate-50">
      <div class="text-center">
        <div class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-slate-500 font-medium">アプリケーションを起動中...</p>
      </div>
    </div>
  </div>

  <script>
    // 互換性のためのエラーハンドリング
    window.onerror = function(msg, url, line) {
      const root = document.getElementById('root');
      if (root) {
        root.innerHTML = '<div class="p-8 text-red-600">エラーが発生しました: ' + msg + '<br>ブラウザのコンソールを確認してください。</div>';
      }
      return false;
    };

    // ライブラリの読み込み完了を待機
    window.onload = function() {
      try {
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const L = window.L;
        const Lucide = window.LucideReact;

        if (!React || !ReactDOM || !L || !Lucide) {
          throw new Error('必要なライブラリの読み込みに失敗しました。インターネット接続を確認してください。');
        }

        const { useState, useEffect, useRef, createElement: h } = React;
        const { createRoot } = ReactDOM;

        // アイコンの取得を安全にする
        const getIcon = (name) => {
          if (Lucide && Lucide[name]) return Lucide[name];
          if (Lucide && Lucide.icons && Lucide.icons[name]) return Lucide.icons[name];
          return (props) => h('span', null, '■');
        };

        const Icons = {
          Compass: getIcon('Compass'),
          Search: getIcon('Search'),
          Settings: getIcon('Settings'),
          Loader2: getIcon('Loader2'),
          Info: getIcon('Info'),
          Users: getIcon('Users'),
          Landmark: getIcon('Landmark'),
          Map: getIcon('Map'),
          Download: getIcon('Download'),
          UserCircle2: getIcon('UserCircle2')
        };

        // Gemini API Client using fetch
        async function callGemini(apiKey, query) {
          // モデル名を gemini-1.5-flash に固定
          const modelName = "gemini-1.5-flash";
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
          
          const payload = {
            contents: [{
              parts: [{
                text: `日本の自治体「${query}」について、Google検索を使用して最新かつ正確な情報を取得し、それに基づき詳しく解説してください。\n特に以下の点に厳格に従ってください：\n1. **事実確認の徹底**: 観光名所、地理的特徴、ゆかりの人物が、確実にその自治体の境界内にあることをGoogle検索で確認してください。隣接自治体との混同は絶対に避けてください。\n2. **根拠のない情報の排除**: 検索結果で確認できない情報は「不明」とするか、出力を控えてください。架空の人物やエピソードを捏造しないでください。\n3. **統計の正確性**: 人口や予算などは、可能な限り最新の公的な数値を反映してください。`
              }]
            }],
            tools: [{ googleSearch: {} }],
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  name: { type: "STRING" },
                  prefecture: { type: "STRING" },
                  description: { type: "STRING" },
                  tourism: { type: "STRING" },
                  people: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        name: { type: "STRING" },
                        bio: { type: "STRING" }
                      },
                      required: ["name", "bio"]
                    }
                  },
                  population: {
                    type: "OBJECT",
                    properties: {
                      total: { type: "STRING" },
                      male: { type: "STRING" },
                      female: { type: "STRING" },
                      agingRate: { type: "STRING" }
                    },
                    required: ["total", "male", "female", "agingRate"]
                  },
                  budget: {
                    type: "OBJECT",
                    properties: {
                      amount: { type: "STRING" },
                      description: { type: "STRING" }
                    },
                    required: ["amount", "description"]
                  },
                  lat: { type: "NUMBER" },
                  lng: { type: "NUMBER" }
                },
                required: ["name", "prefecture", "description", "tourism", "people", "population", "budget", "lat", "lng"]
              }
            }
          };

          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const err = await response.json();
            const msg = err.error?.message || "";
            
            if (response.status === 404 || msg.includes("not found")) {
              throw new Error('MODEL_NOT_FOUND');
            }
            if (response.status === 429 || msg.includes("quota")) {
              throw new Error('QUOTA_EXCEEDED');
            }
            if (response.status === 400 && msg.includes("API key")) {
              throw new Error('INVALID_API_KEY');
            }
            throw new Error(msg || 'APIリクエストに失敗しました');
          }

          const result = await response.json();
          if (!result.candidates || !result.candidates[0]) {
            throw new Error('AIからの応答が空でした。');
          }
          return JSON.parse(result.candidates[0].content.parts[0].text);
        }

        function App() {
          const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
          const [showSettings, setShowSettings] = useState(!localStorage.getItem('gemini_api_key'));
          const [query, setQuery] = useState('');
          const [loading, setLoading] = useState(false);
          const [data, setData] = useState(null);
          const [error, setError] = useState(null);
          
          const mapRef = useRef(null);
          const markerRef = useRef(null);
          const geoJsonRef = useRef(null);

          // Initialize Map
          useEffect(() => {
            const mapEl = document.getElementById('map');
            if (mapEl && !mapRef.current) {
              mapRef.current = L.map('map').setView([36.2048, 138.2529], 5);
              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap'
              }).addTo(mapRef.current);

              fetch('https://raw.githubusercontent.com/niiyz/JapanGeoJson/master/japan.json')
                .then(res => res.json())
                .then(geoData => {
                  if (mapRef.current) {
                    geoJsonRef.current = L.geoJSON(geoData, {
                      style: { color: '#10b981', weight: 1, fillColor: '#10b981', fillOpacity: 0.05 }
                    }).addTo(mapRef.current);
                  }
                });
            }
          }, []);

          const saveApiKey = () => {
            localStorage.setItem('gemini_api_key', apiKey);
            setShowSettings(false);
            setError(null);
          };

          const handleSearch = async (e) => {
            e.preventDefault();
            if (!query.trim()) return;
            if (!apiKey) {
              setError('APIキーが設定されていません。右上の設定アイコンからAPIキーを入力してください。');
              setShowSettings(true);
              return;
            }

            setLoading(true);
            setError(null);

            try {
              const result = await callGemini(apiKey, query);
              setData(result);

              if (mapRef.current) {
                const pos = [result.lat, result.lng];
                mapRef.current.setView(pos, 5);
                if (markerRef.current) markerRef.current.remove();
                markerRef.current = L.circleMarker(pos, {
                  color: '#ff0000', fillColor: '#ff0000', fillOpacity: 0.9, weight: 2, radius: 10
                }).addTo(mapRef.current);
                setTimeout(() => mapRef.current.invalidateSize(), 200);
              }
            } catch (err) {
              console.error(err);
              if (err.message === 'QUOTA_EXCEEDED') {
                setError('現在混み合っています。少し時間を置いてから再度お試しいただくか、設定からAPIキーを確認してください。');
              } else if (err.message === 'MODEL_NOT_FOUND') {
                setError('指定されたAIモデルが見つかりません。APIキーが有効であるか、またはGoogle AI Studioの設定を確認してください。');
              } else if (err.message === 'INVALID_API_KEY') {
                setError('APIキーが無効です。設定から正しいAPIキーを入力し直してください。');
              } else {
                setError(err.message || '情報の取得に失敗しました。');
              }
            } finally {
              setLoading(false);
            }
          };

          const saveReport = (format) => {
            if (!data) return;
            let content = '';
            let mimeType = '';
            let extension = '';

            if (format === 'html') {
              content = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${data.name} レポート</title><style>body { font-family: sans-serif; padding: 40px; color: #334155; line-height: 1.6; } h1 { color: #10b981; border-bottom: 2px solid #10b981; padding-bottom: 10px; } .section { margin-bottom: 30px; } .label { font-weight: bold; color: #64748b; } .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; } .card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; }</style></head><body><h1>${data.name} (${data.prefecture})</h1><div class="section"><p>${data.description}</p></div><div class="section"><h2>観光・地域の特徴</h2><p>${data.tourism}</p></div><div class="section"><h2>人口統計</h2><div class="grid"><div class="card"><span class="label">総人口:</span> ${data.population.total}</div><div class="card"><span class="label">高齢化率:</span> ${data.population.agingRate}</div></div></div><div class="section"><h2>予算規模</h2><p>${data.budget.amount} (${data.budget.description})</p></div></body></html>`;
              mimeType = 'text/html';
              extension = 'html';
            } else {
              content = `【${data.name} 自治体レポート】\n都道府県: ${data.prefecture}\n\n■ 概要\n${data.description}\n\n■ 観光・地域の特徴\n${data.tourism}\n\n■ 人口統計\n・総人口: ${data.population.total}\n・高齢化率: ${data.population.agingRate}\n\n■ 予算規模\n・予算額: ${data.budget.amount}\n・詳細: ${data.budget.description}\n\n■ ゆかりのある人物\n${data.people.map(p => `・${p.name}: ${p.bio}`).join('\n')}\n\n---\n生成日: ${new Date().toLocaleDateString('ja-JP')}\nAI市町村ナビ`;
              mimeType = 'text/plain';
              extension = 'txt';
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.name}_report.${extension}`;
            a.click();
            URL.revokeObjectURL(url);
          };

          const renderValueWithSmallUnit = (value, baseSize = "text-4xl") => {
            if (!value || value === '---') return value;
            const parts = value.split(/([人|万円|億円|%]+)/);
            return h('span', { className: baseSize + ' font-bold text-slate-800' },
              parts.map((part, i) => {
                if (['人', '万円', '億円', '%'].includes(part)) {
                  return h('span', { key: i, className: 'text-sm font-medium text-slate-400 ml-0.5' }, part);
                }
                return part;
              })
            );
          };

          return h('div', { className: 'min-h-screen flex flex-col' },
            h('header', { className: 'bg-white border-b border-slate-200 py-4 px-6 sticky top-0 z-50' },
              h('div', { className: 'max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4' },
                h('div', { className: 'flex items-center gap-2' },
                  h('div', { className: 'w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white' },
                    h(Icons.Compass, { size: 20 })
                  ),
                  h('h1', { className: 'text-xl font-bold tracking-tight text-slate-800' }, '市町村ナビ')
                ),
                h('div', { className: 'flex items-center gap-3 w-full sm:w-auto' },
                  h('form', { onSubmit: handleSearch, className: 'relative flex-1 sm:w-80' },
                    h(Icons.Search, { size: 16, className: 'absolute left-3 top-1/2 -translate-y-1/2 text-slate-400' }),
                    h('input', {
                      type: 'text', value: query, onChange: (e) => setQuery(e.target.value), placeholder: '南相木村',
                      className: 'w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-full focus:ring-2 focus:ring-brand/20 focus:outline-none text-sm'
                    }),
                    h('button', {
                      type: 'submit', disabled: loading,
                      className: 'absolute right-1 top-1/2 -translate-y-1/2 bg-brand text-white px-4 py-1 rounded-full text-xs font-bold hover:bg-brand/90 transition-colors disabled:opacity-50'
                    }, loading ? h(Icons.Loader2, { size: 12, className: 'animate-spin' }) : '検索')
                  ),
                  h('button', { onClick: () => setShowSettings(!showSettings), className: 'p-2 text-slate-400 hover:text-slate-600 transition-colors' }, h(Icons.Settings, { size: 20 }))
                )
              )
            ),
            showSettings && h('div', { className: 'bg-slate-50 border-b border-slate-200' },
              h('div', { className: 'max-w-7xl mx-auto p-6' },
                h('div', { className: 'flex flex-col sm:flex-row gap-3 items-end' },
                  h('div', { className: 'flex-1 w-full' },
                    h('label', { className: 'block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider' }, 'Gemini API Key'),
                    h('input', {
                      type: 'password', value: apiKey, onChange: (e) => setApiKey(e.target.value), placeholder: 'Enter your API key',
                      className: 'w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand/20 bg-white'
                    })
                  ),
                  h('button', { onClick: saveApiKey, className: 'bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700 transition-colors font-bold text-sm' }, 'Save')
                )
              )
            ),
            h('main', { className: 'flex-1 max-w-7xl w-full mx-auto p-6' },
              error && h('div', { className: 'bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl mb-6 flex items-center gap-2 text-sm' }, h(Icons.Info, { size: 16 }), error),
              h('div', { className: 'grid grid-cols-1 lg:grid-cols-12 gap-6' },
                h('div', { className: 'lg:col-span-4 space-y-6' },
                  h('div', { className: 'bg-white rounded-2xl shadow-sm border border-slate-200 p-6' },
                    h('div', { className: 'flex items-baseline gap-2 mb-2' },
                      h('h2', { className: 'text-2xl font-bold text-slate-800' }, data ? data.name : '---'),
                      h('span', { className: 'text-sm text-slate-400 font-medium' }, data ? data.prefecture : '---')
                    ),
                    h('p', { className: 'text-sm text-slate-500 leading-relaxed mb-6' }, data ? data.description : '市町村を検索して情報を表示してください。'),
                    h('div', { id: 'map', className: 'mb-6' }),
                    h('div', { className: 'space-y-2' },
                      h('button', { onClick: () => saveReport('html'), disabled: !data, className: 'w-full flex items-center justify-center gap-2 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl transition-colors text-sm font-bold disabled:opacity-50' }, h(Icons.Download, { size: 16 }), ' レポートを保存 (HTML形式)'),
                      h('button', { onClick: () => saveReport('text'), disabled: !data, className: 'w-full flex items-center justify-center gap-2 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl transition-colors text-sm font-bold disabled:opacity-50' }, h(Icons.Download, { size: 16 }), ' レポートを保存 (テキスト形式)')
                    )
                  ),
                  h('div', { className: 'bg-white rounded-2xl shadow-sm border border-slate-200 p-6' },
                    h('div', { className: 'flex items-center justify-between mb-6' }, h('div', { className: 'flex items-center gap-2 text-brand font-bold text-sm' }, h(Icons.Users, { size: 16 }), ' 人口統計'), h('span', { className: 'text-[10px] text-slate-300 font-bold uppercase tracking-widest' }, '2023年')),
                    h('div', { className: 'mb-6' }, renderValueWithSmallUnit(data ? data.population.total : '---', 'text-4xl'), h('div', { className: 'text-[10px] text-slate-400 font-bold uppercase mt-1' }, '総人口')),
                    h('div', { className: 'grid grid-cols-2 gap-4 border-t border-slate-100 pt-6 mb-6' },
                      h('div', {}, renderValueWithSmallUnit(data ? data.population.male : '---', 'text-lg'), h('div', { className: 'text-[10px] text-slate-400 font-bold uppercase mt-1' }, '男')),
                      h('div', {}, renderValueWithSmallUnit(data ? data.population.female : '---', 'text-lg'), h('div', { className: 'text-[10px] text-slate-400 font-bold uppercase mt-1' }, '女'))
                    ),
                    h('div', { className: 'border-t border-slate-100 pt-6' }, renderValueWithSmallUnit(data ? data.population.agingRate : '---', 'text-xl'), h('div', { className: 'text-[10px] text-slate-400 font-bold uppercase mt-1' }, '高齢化率 (65歳以上)'))
                  ),
                  h('div', { className: 'bg-white rounded-2xl shadow-sm border border-slate-200 p-6' },
                    h('div', { className: 'flex items-center justify-between mb-6' }, h('div', { className: 'flex items-center gap-2 text-brand font-bold text-sm' }, h(Icons.Landmark, { size: 16 }), ' 予算規模'), h('span', { className: 'text-[10px] text-slate-300 font-bold uppercase tracking-widest' }, '2024年度')),
                    h('div', { className: 'mb-2' }, renderValueWithSmallUnit(data ? data.budget.amount : '---', 'text-2xl')),
                    h('p', { className: 'text-xs text-slate-400 leading-relaxed' }, data ? data.budget.description : '---')
                  )
                ),
                h('div', { className: 'lg:col-span-8 space-y-6' },
                  h('div', { className: 'bg-white rounded-2xl shadow-sm border border-slate-200 p-8' },
                    h('div', { className: 'flex items-center gap-3 mb-6' }, h('div', { className: 'w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-brand' }, h(Icons.Map, { size: 20 })), h('h3', { className: 'text-lg font-bold text-slate-800' }, '観光・地域の特徴')),
                    h('p', { className: 'text-slate-600 leading-relaxed' }, data ? data.tourism : '検索結果がここに表示されます。')
                  ),
                  h('div', { className: 'bg-white rounded-2xl shadow-sm border border-slate-200 p-8' },
                    h('div', { className: 'flex items-center gap-3 mb-8' }, h('div', { className: 'w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-brand' }, h(Icons.UserCircle2, { size: 20 })), h('h3', { className: 'text-lg font-bold text-slate-800' }, 'ゆかりのある人物')),
                    h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' }, data ? data.people.map((person, i) => h('div', { key: i, className: 'bg-slate-50 rounded-xl p-6 border border-slate-100' }, h('h4', { className: 'text-brand font-bold mb-2' }, person.name), h('p', { className: 'text-xs text-slate-500 leading-relaxed' }, person.bio))) : h('div', { className: 'col-span-full py-12 text-center text-slate-300 italic text-sm' }, '人物情報がありません'))
                  )
                )
              )
            ),
            h('footer', { className: 'py-8 px-6 text-center space-y-2' },
              h('p', { className: 'text-[10px] text-slate-400 font-bold uppercase tracking-widest' }, '© 2024 AI市町村ナビ 制作委員会'),
              h('p', { className: 'text-[9px] text-slate-300 italic' }, '※AI生成コンテンツには誤りが含まれる場合があります。重要な情報は公的機関の資料でご確認ください。')
            )
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(h(App));
      } catch (e) {
        console.error('Initialization error:', e);
        document.getElementById('root').innerHTML = '<div class="p-8 text-red-600">初期化エラー: ' + e.message + '</div>';
      }
    };
  </script>
</body>
</html>